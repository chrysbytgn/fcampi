<!DOCTYPE html>
<html lang="es">
<head>
    <title>CampiClock</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style> /* Tus estilos van aquí */ </style>
</head>
<body>
    <div id="login-view">
        <input type="email" id="email-input" placeholder="Tu correo electrónico">
        <div id="pin-display"></div>
        <button data-action="login">Entrar</button>
        <p id="login-error"></p>
    </div>

    <script type="module">
        const SUPABASE_URL = 'TU_SUPABASE_URL';
        const SUPABASE_ANON_KEY = 'TU_SUPABASE_ANON_KEY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentPin = ''; // La lógica para manejar el PIN va aquí

        // ESTA ES LA FUNCIÓN DE LOGIN CORRECTA
        const login = async () => {
            const loginError = document.getElementById('login-error');
            const email = document.getElementById('email-input').value;
            loginError.textContent = '';

            if (!email || currentPin.length !== 4) {
                loginError.textContent = 'Correo y PIN de 4 dígitos son requeridos.';
                return;
            }

            try {
                // 1. Llamar a la Edge Function segura
                const { data, error: funcError } = await supabase.functions.invoke('login-with-pin', {
                    body: { email: email, pin: currentPin },
                });

                if (funcError) throw funcError;

                // 2. Establecer la sesión oficial con el token recibido
                const { data: sessionData, error: sessionError } = await supabase.auth.setSession({
                    access_token: data.session.access_token,
                    refresh_token: data.session.refresh_token,
                });

                if (sessionError) throw sessionError;

                // 3. Si todo va bien, el usuario está autenticado y puedes redirigir
                // La app se recargará automáticamente por el `onAuthStateChange`
                
            } catch (err) {
                console.error("Error en login:", err);
                loginError.textContent = 'Credenciales incorrectas o error en el servidor.';
                // limpiarPin();
            }
        };

        // Tu código de onAuthStateChange, logout, etc. va aquí
        
        document.querySelector('[data-action="login"]').addEventListener('click', login);

    </script>
</body>
</html>





